<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            margin: 40px 0 0 0;
            padding: 0;
            background-color: #EEE;
            text-align: center;
        }

        #screen {
            border: 1px solid #CCC;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            width: 200px;
            height: 200px;
            -webkit-box-shadow: 0px 4px 17px 0px rgba(0, 0, 0, 0.19);
            -moz-box-shadow: 0px 4px 17px 0px rgba(0, 0, 0, 0.19);
            box-shadow: 0px 4px 17px 0px rgba(0, 0, 0, 0.19);
            margin-bottom: 20px;
            margin-left: 20px;
            margin-right: 20px;
            display: inline-block;
            vertical-align: top;
        }
    </style>
</head>

<body>
    <div id="div-set-name">
        <input id="player-name">
        <button id="bt-set-player-name">set my name</button>
    </div>
    <canvas id="screen" height="20" width="20"></canvas>

    <div id="player-list"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="./game.js"></script>
    <script src="./render-screen.js"></script>
    <script src="./keyboard-listener.js"></script>

    <script>
        const socket = io();
        const game = createGame();
        const collectAudio = new Audio('collect.mp3')

        function setPlayerName(playerName) {
            socket.emit('setName', { name: playerName })
        }
        setPlayerName('Annonymous')

        const canvas = document.getElementById('screen')
        const context = canvas.getContext('2d')

        socket.on('stateChanged', (state) => {
            game.setState(state);
            mostraPlayers();
        })

        socket.on('start', (state) => {
            game.state = state
            renderScreen(game.state, context)
        })

        function movePlayer(command) {
            console.log(command)
            game.movePlayer(command);
            collectAudio.play()
            socket.emit('movePlayer', command)
        }

        const keysValids = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];

        function keyValid(key) {
            return keysValids.includes(key);
        }

        function keydown(event) {
            if (!keyValid(event.key))
                return;
            const command = {
                'playerId': socket.id,
                'key': event.key
            }
            movePlayer(command)
        }

        createKeyboardListener(document, keydown)

        document.getElementById('bt-set-player-name').addEventListener('click', () => {
            const inputText = document.getElementById('player-name').value;
            setPlayerName(inputText);

            document.getElementById('player-name').value = ''
            // document.getElementById('div-set-name').setAttribute('hidden',true);
        })

        function mostraPlayers() {
            const divPlayers = document.getElementById('player-list');
            var playersHtml = '';
            for (item in game.state.players) {
                playersHtml = playersHtml + game.state.players[item].name + ' Pontos: ' + game.state.players[item].points + '<br />'
            }
            divPlayers.innerHTML = playersHtml
        }
    </script>
</body>

</html>